<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驻  - 专砖转</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .admin-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--neutral-200);
            margin-bottom: 2rem;
        }
        .admin-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--neutral-600);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        .admin-tab:hover {
            color: var(--primary);
        }
        .admin-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .admin-section {
            display: none;
        }
        .admin-section.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: var(--neutral-600);
            font-size: 0.875rem;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        .user-table th,
        .user-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--neutral-200);
        }
        .user-table th {
            background-color: var(--neutral-100);
            font-weight: 700;
            color: var(--neutral-800);
        }
        .user-table tr:hover {
            background-color: var(--neutral-100);
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-start;
        }
        /* Custom Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-box {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1rem;
        }
        .modal-message {
            color: var(--neutral-600);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-message" id="modal-message"></div>
            <div class="modal-buttons">
                <button class="btn btn-outline" id="modal-cancel"></button>
                <button class="btn btn-primary" id="modal-confirm">砖专</button>
            </div>
        </div>
    </div>

    <!-- Listing Details Modal -->
    <div id="listing-details-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--primary); margin: 0;">驻专 驻专住</h2>
                <button class="btn btn-outline btn-sm" id="close-listing-modal-btn">住专</button>
            </div>
            <div id="listing-details-content">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo"><img src="/images/logo.png" alt="专砖转" style="height: 100px; vertical-align: middle;"> - 驻 </div>
                <ul class="nav-links">
                    <li><a href="/">注 转</a></li>
                    <li><a href="/dashboard"> 拽专</a></li>
                    <li><a href="/listings">爪 </a></li>
                    <li><a href="#" id="logout-btn" class="btn btn-outline btn-sm">转转拽</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="section">
        <div class="container">
            <h1 style="color: var(--primary); margin-bottom: 2rem;">驻 </h1>

            <!-- Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="stats">住住拽转</button>
                <button class="admin-tab" data-tab="pending">转 砖专</button>
                <button class="admin-tab" data-tab="users"> 砖转砖</button>
                <button class="admin-tab" data-tab="listings"> 驻专住</button>
                <button class="admin-tab" data-tab="audit"> 驻注转</button>
            </div>

            <!-- Statistics Section -->
            <div class="admin-section active" id="section-stats">
                <h2 style="color: var(--secondary); margin-bottom: 1.5rem;">住住拽转 转</h2>
                <div class="stats-grid" id="stats-container">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Pending Volunteers Section -->
            <div class="admin-section" id="section-pending">
                <h2 style="color: var(--secondary); margin-bottom: 1.5rem;">转 转 砖专</h2>
                <div id="pending-container">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Users Management Section -->
            <div class="admin-section" id="section-users">
                <h2 style="color: var(--secondary); margin-bottom: 1.5rem;"> 砖转砖</h2>
                
                <!-- Filters -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">住 驻 转驻拽</label>
                            <select class="form-select" id="users-role-filter">
                                <option value=""></option>
                                <option value="user">砖转砖 专</option>
                                <option value="pending_volunteer">转 砖专</option>
                                <option value="verified_volunteer">转 转</option>
                                <option value="admin"></option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label class="form-label">驻砖</label>
                            <input type="text" class="form-input" id="users-search" placeholder="驻砖 驻 砖  驻">
                        </div>
                        <button class="btn btn-primary" id="search-users-btn">驻砖</button>
                    </div>
                </div>

                <div id="users-container">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Listings Management Section -->
            <div class="admin-section" id="section-listings">
                <h2 style="color: var(--secondary); margin-bottom: 1.5rem;"> 驻专住</h2>
                
                <!-- Filters -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0; min-width: 150px;">
                            <label class="form-label">住住</label>
                            <select class="form-select" id="listings-status-filter">
                                <option value="all"></option>
                                <option value="available"></option>
                                <option value="unavailable"> </option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2; margin-bottom: 0; min-width: 200px;">
                            <label class="form-label">驻砖</label>
                            <input type="text" class="form-input" id="listings-search" placeholder="驻砖 驻 转专转  转专">
                        </div>
                    </div>
                </div>

                <div id="listings-admin-container">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Audit Log Section -->
            <div class="admin-section" id="section-audit">
                <h2 style="color: var(--secondary); margin-bottom: 1.5rem;"> 驻注转 </h2>
                <div id="audit-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 专砖转 - 驻驻专转 砖转祝 爪 转 状</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: rgba(255, 255, 255, 0.7);">
                驻转 注  <a href="https://sanda-uinc.onrender.com/" target="_blank" rel="noopener noreferrer" style="color: #ffffff; text-decoration: underline;">Sand</a>
            </p>
        </div>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        // Require authentication and admin role
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        if (!hasRole(['admin'])) {
            alert('  专砖 砖转 驻 ');
            window.location.href = '/dashboard';
        }

        // Handle logout
        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                await authAPI.logout();
                window.location.href = '/';
            } catch (error) {
                clearAuthSession();
                window.location.href = '/';
            }
        });

        // Handle close listing modal button
        document.getElementById('close-listing-modal-btn').addEventListener('click', closeListingModal);

        // Tab switching
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active section
                document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                document.getElementById(`section-${tabName}`).classList.add('active');
                
                // Load content if needed
                if (tabName === 'stats') loadStats();
                if (tabName === 'listings') loadAllListings();
                else if (tabName === 'pending') loadPending();
                else if (tabName === 'users') loadUsers();
                else if (tabName === 'audit') loadAuditLog();
            });
        });

        // Load Statistics
        async function loadStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const data = await adminAPI.getStats();
                const stats = data.stats;

                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_users}</div>
                        <div class="stat-label">住状 砖转砖</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--warning);">${stats.pending_volunteers}</div>
                        <div class="stat-label">转 砖专</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--success);">${stats.verified_volunteers}</div>
                        <div class="stat-label">转 转</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--secondary);">${stats.admins}</div>
                        <div class="stat-label"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--accent);">${stats.active_listings || 0}</div>
                        <div class="stat-label">驻专住 驻注</div>
                    </div>
                `;
            } catch (error) {
                console.error('Load stats error:', error);
                container.innerHTML = '<div class="alert alert-error">砖 注转 住住拽转</div>';
            }
        }

        // Load Pending Volunteers
        async function loadPending() {
            const container = document.getElementById('pending-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const data = await adminAPI.getPendingVolunteers();
                
                if (data.pending.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"> 转 转 砖专 专注</div>';
                    return;
                }

                container.innerHTML = `
                    <div class="card">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>砖 </th>
                                    <th></th>
                                    <th>专</th>
                                    <th>驻</th>
                                    <th>转专 专砖</th>
                                    <th>驻注转</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.pending.map(user => `
                                    <tr>
                                        <td>${user.full_name}</td>
                                        <td>${user.email}</td>
                                        <td>${user.merhav}</td>
                                        <td>${user.phone || '-'}</td>
                                        <td>${formatDate(user.created_at)}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn btn-sm btn-success approve-volunteer-btn" data-user-id="${user.id}" data-user-name="${user.full_name}">砖专</button>
                                                <button class="btn btn-sm btn-danger reject-volunteer-btn" data-user-id="${user.id}" data-user-name="${user.full_name}"></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Load pending error:', error);
                container.innerHTML = '<div class="alert alert-error">砖 注转 专砖转 转</div>';
            }
        }

        // Load Users
        async function loadUsers() {
            const container = document.getElementById('users-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const filters = {
                    role: document.getElementById('users-role-filter').value,
                    search: document.getElementById('users-search').value
                };

                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                const data = await adminAPI.getUsers(filters);
                
                if (data.users.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"> 爪 砖转砖</div>';
                    return;
                }

                const roleMap = {
                    'user': '砖转砖 专',
                    'pending_volunteer': '转 砖专',
                    'verified_volunteer': '转 转',
                    'admin': ''
                };

                container.innerHTML = `
                    <div class="card">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>砖 </th>
                                    <th>驻</th>
                                    <th>转驻拽</th>
                                    <th>专</th>
                                    <th>转专 爪专驻转</th>
                                    <th>驻注转</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr>
                                        <td>${user.full_name}</td>
                                        <td>${user.phone || ' 爪'}</td>
                                        <td><span class="badge badge-${user.role === 'admin' ? 'primary' : user.role === 'verified_volunteer' ? 'success' : 'secondary'}">${roleMap[user.role]}</span></td>
                                        <td>${user.merhav}</td>
                                        <td>${formatDate(user.created_at)}</td>
                                        <td>
                                            <div class="action-buttons">
                                                ${user.username === 'admin' ? 
                                                    `<span class="badge badge-warning"></span>` 
                                                    : user.role !== 'admin' ? 
                                                    `<button class="btn btn-sm btn-primary promote-admin-btn" data-user-id="${user.id}" data-user-name="${user.full_name}">拽 </button>` 
                                                    : 
                                                    `<button class="btn btn-sm btn-warning demote-admin-btn" data-user-id="${user.id}" data-user-name="${user.full_name}">住专 </button>`
                                                }
                                                ${user.username !== 'admin' ? 
                                                    `<button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" data-user-name="${user.full_name}">拽 砖转砖</button>` 
                                                    : ''
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Load users error:', error);
                container.innerHTML = '<div class="alert alert-error">砖 注转 砖转砖</div>';
            }
        }

        // Load All Listings for admin
        async function loadAllListings() {
            const container = document.getElementById('listings-admin-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const statusFilter = document.getElementById('listings-status-filter').value;
                const search = document.getElementById('listings-search').value;

                // Fetch all listings using admin API
                const data = await listingsAPI.getAll({ search });
                
                // Filter by status on frontend
                let filteredListings = data.listings;
                if (statusFilter === 'available') {
                    filteredListings = data.listings.filter(l => l.is_available);
                } else if (statusFilter === 'unavailable') {
                    filteredListings = data.listings.filter(l => !l.is_available);
                }

                if (filteredListings.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"> 爪 驻专住</div>';
                    return;
                }

                container.innerHTML = filteredListings.map(listing => {
                    const owner = listing.owner || {};
                    return `
                        <div class="card admin-listing-card" data-listing-id="${listing.id}" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                <div style="flex: 1;">
                                    <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${listing.title}</h3>
                                    <div style="margin-bottom: 0.75rem;">
                                        <span class="badge badge-secondary">${listing.category}</span>
                                        <span class="badge badge-primary">${listing.transaction_type}</span>
                                        ${listing.size ? `<span class="badge badge-secondary">${listing.size}</span>` : ''}
                                        ${listing.volunteer_only ? '<span class="badge badge-warning">转 </span>' : ''}
                                        <span class="badge badge-${listing.is_available ? 'success' : 'error'}">${listing.is_available ? '' : ' '}</span>
                                    </div>
                                    ${listing.description ? `<p style="color: var(--neutral-600); margin-bottom: 0.75rem;">${listing.description}</p>` : ''}
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <p style="margin: 0;"><strong>专:</strong> ${listing.merhav}</p>
                                        <p style="margin: 0;"><strong>驻专住:</strong> ${owner.full_name || ' 注'}</p>
                                    </div>
                                    <p style="font-size: 0.875rem; color: var(--neutral-600); margin: 0;">
                                        驻专住: ${formatDate(listing.created_at)}
                                    </p>
                                    <p style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary); font-style: italic;">
                                         抓 爪驻 驻专 
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event delegation for listing clicks
                document.querySelectorAll('.admin-listing-card').forEach(card => {
                    card.addEventListener('click', function() {
                        showListingDetails(this.dataset.listingId);
                    });
                });

            } catch (error) {
                console.error('Load listings error:', error);
                container.innerHTML = '<div class="alert alert-error">砖 注转 驻专住</div>';
            }
        }

        // Load Audit Log
        async function loadAuditLog() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const data = await adminAPI.getAuditLog(100);
                
                if (data.log.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"> 驻注转 </div>';
                    return;
                }

                const actionMap = {
                    'approve_volunteer': '砖专 转',
                    'reject_volunteer': '转 拽砖转 转',
                    'promote_admin': '拽 ',
                    'demote_admin': '专 '
                };

                container.innerHTML = data.log.map(entry => `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${actionMap[entry.action] || entry.action}</strong><br>
                                <span class="text-muted">: ${entry.admin?.full_name || ' 注'}</span><br>
                                <span class="text-muted">砖转砖: ${entry.target_user?.full_name || ' 注'}</span>
                            </div>
                            <div style="text-align: left; color: var(--neutral-600); font-size: 0.875rem;">
                                ${formatDate(entry.created_at)}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Load audit log error:', error);
                container.innerHTML = '<div class="alert alert-error">砖 注转  驻注转</div>';
            }
        }

        // Show listing details in modal
        async function showListingDetails(listingId) {
            const modal = document.getElementById('listing-details-modal');
            const content = document.getElementById('listing-details-content');
            
            modal.classList.add('show');
            content.innerHTML = '<div class="spinner"></div>';

            try {
                const response = await fetch(`/api/listings/${listingId}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load listing');
                }

                const data = await response.json();
                const listing = data.listing;
                const owner = listing.owner || {};
                
                const whatsappMessage = encodeURIComponent(`, 注 ${listing.title} 砖驻专住转`);
                const whatsappLink = owner.phone ? `https://wa.me/972${owner.phone.replace(/^0/, '')}?text=${whatsappMessage}` : '';

                content.innerHTML = `
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 1rem;">${listing.title}</h3>
                        
                        ${(listing.image1 || listing.image2) ? `
                            <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                ${listing.image1 ? `<img src="${listing.image1}" alt="${listing.title}" style="max-width: 250px; width: 100%; height: auto; object-fit: cover; border-radius: 8px;" />` : ''}
                                ${listing.image2 ? `<img src="${listing.image2}" alt="${listing.title}" style="max-width: 250px; width: 100%; height: auto; object-fit: cover; border-radius: 8px;" />` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span class="badge badge-secondary">${listing.category}</span>
                            <span class="badge badge-primary">${listing.transaction_type}</span>
                            ${listing.size ? `<span class="badge badge-secondary">${listing.size}</span>` : ''}
                            ${listing.volunteer_only ? '<span class="badge badge-warning">转 </span>' : ''}
                            <span class="badge badge-${listing.is_available ? 'success' : 'error'}">${listing.is_available ? '' : ' '}</span>
                        </div>

                        ${listing.description ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">转专</h4>
                                <p style="color: var(--neutral-700);">${listing.description}</p>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>专:</strong> ${listing.merhav}
                            </div>
                            <div>
                                <strong>驻专住:</strong> ${owner.full_name || ' 注'}
                            </div>
                            ${owner.phone ? `
                                <div>
                                    <strong>驻:</strong> ${owner.phone}
                                </div>
                            ` : ''}
                            <div>
                                <strong>驻专住:</strong> ${formatDate(listing.created_at)}
                            </div>
                            <div>
                                <strong>爪驻转:</strong> ${listing.views || 0}
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--neutral-200);">
                            ${whatsappLink ? `
                                <a href="${whatsappLink}" target="_blank" rel="noopener noreferrer" class="btn btn-success">
                                    砖 注 住驻
                                </a>
                            ` : ''}
                            <button class="btn btn-secondary" id="edit-listing-btn" data-listing-id="${listing.id}">
                                注专 驻专住
                            </button>
                            <button class="btn btn-danger" id="delete-listing-btn" data-listing-id="${listing.id}">
                                拽 驻专住
                            </button>
                        </div>
                    </div>
                `;

                // Add event listeners for modal buttons
                document.getElementById('edit-listing-btn')?.addEventListener('click', function() {
                    window.location.href = `/create-listing?id=${this.dataset.listingId}`;
                });
                
                document.getElementById('delete-listing-btn')?.addEventListener('click', function() {
                    deleteListingFromModal(this.dataset.listingId);
                });

            } catch (error) {
                console.error('Load listing error:', error);
                content.innerHTML = '<div class="alert alert-error">砖 注转 驻专住</div>';
            }
        }

        function closeListingModal() {
            document.getElementById('listing-details-modal').classList.remove('show');
        }

        async function deleteListingFromModal(listingId) {
            const confirmed = await showConfirm(
                '拽转 驻专住',
                ' 转  砖专爪 拽 驻专住 ?'
            );

            if (confirmed) {
                try {
                    await listingsAPI.delete(listingId);
                    closeListingModal();
                    loadAllListings();
                } catch (error) {
                    alert('砖 拽转 驻专住');
                }
            }
        }

        // Custom confirm modal
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.add('show');

                const cleanup = () => {
                    modal.classList.remove('show');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    modal.removeEventListener('click', onOverlayClick);
                };

                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const onOverlayClick = (e) => {
                    if (e.target === modal) {
                        cleanup();
                        resolve(false);
                    }
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
                modal.addEventListener('click', onOverlayClick);
            });
        }

        // Approve volunteer
        async function approveVolunteer(userId, name) {
            const confirmed = await showConfirm(
                '砖专 转',
                ` 转  砖专爪 砖专 转 ${name} 转 转?`
            );
            
            if (!confirmed) return;

            try {
                await adminAPI.approveVolunteer(userId);
                showSuccess(`${name} 砖专 爪 转`);
                loadPending();
                loadStats();
            } catch (error) {
                console.error('Approve error:', error);
                showError(error.message || '砖 砖专 转');
            }
        }

        // Reject volunteer
        async function rejectVolunteer(userId, name) {
            const confirmed = await showConfirm(
                '转 拽砖',
                ` 转  砖专爪 转 转 拽砖转 ${name}?`
            );
            
            if (!confirmed) return;

            try {
                await adminAPI.rejectVolunteer(userId);
                showSuccess(`拽砖转 ${name} 转`);
                loadPending();
                loadStats();
            } catch (error) {
                console.error('Reject error:', error);
                showError(error.message || '砖 转 拽砖');
            }
        }

        // Promote to admin
        async function promoteToAdmin(userId, name) {
            const confirmed = await showConfirm(
                '拽 ',
                ` 转  砖专爪 拽 转 ${name} ?\n\n  砖专 转, 拽 砖转砖 专  转 驻驻专.`
            );
            
            if (!confirmed) return;

            try {
                await adminAPI.promoteAdmin(userId);
                showSuccess(`${name} 拽  爪`);
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Promote error:', error);
                showError(error.message || '砖 拽 ');
            }
        }

        // Demote admin
        async function demoteAdmin(userId, name) {
            const confirmed = await showConfirm(
                '住专转 专砖转 ',
                ` 转  砖专爪 住专 转 专砖转  -${name}?`
            );
            
            if (!confirmed) return;

            try {
                await adminAPI.demoteAdmin(userId);
                showSuccess(`专砖转  砖 ${name} 住专`);
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Demote error:', error);
                showError(error.message || '砖 专转 专砖转');
            }
        }

        // Delete user
        async function deleteUser(userId, name) {
            const confirmed = await showConfirm(
                '拽转 砖转砖',
                ` 转  砖专爪 拽 转 砖转砖 ${name}? 驻注  转 驻 转拽 转  驻专住 转 砖 砖转砖.`
            );
            
            if (!confirmed) return;

            try {
                await adminAPI.deleteUser(userId);
                showSuccess(`砖转砖 ${name} 拽 爪`);
                loadUsers();
                loadStats();
            } catch (error) {
                console.error('Delete user error:', error);
                showError(error.message || '砖 拽转 砖转砖');
            }
        }

        // Search users button
        document.getElementById('search-users-btn').addEventListener('click', loadUsers);

        // Live search - search as user types
        let searchTimeout;
        document.getElementById('users-search').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadUsers();
            }, 300); // Wait 300ms after user stops typing
        });

        // Also allow enter key to search immediately
        document.getElementById('users-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                loadUsers();
            }
        });

        // Live filter by role
        document.getElementById('users-role-filter').addEventListener('change', loadUsers);

        // Listings filters - live search
        let listingsSearchTimeout;
        document.getElementById('listings-search').addEventListener('input', function() {
            clearTimeout(listingsSearchTimeout);
            listingsSearchTimeout = setTimeout(() => {
                loadAllListings();
            }, 300);
        });

        // Live filter by status
        document.getElementById('listings-status-filter').addEventListener('change', loadAllListings);

        // Event delegation for dynamically created buttons
        document.addEventListener('click', function(e) {
            // Approve volunteer button
            if (e.target.classList.contains('approve-volunteer-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                approveVolunteer(userId, userName);
            }
            // Reject volunteer button
            else if (e.target.classList.contains('reject-volunteer-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                rejectVolunteer(userId, userName);
            }
            // Promote to admin button
            else if (e.target.classList.contains('promote-admin-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                promoteToAdmin(userId, userName);
            }
            // Demote admin button
            else if (e.target.classList.contains('demote-admin-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                demoteAdmin(userId, userName);
            }
            // Delete user button
            else if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.dataset.userId;
                const userName = e.target.dataset.userName;
                deleteUser(userId, userName);
            }
        });

        // Initial load
        loadStats();
    </script>
</body>
</html>
